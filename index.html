<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Chat - SARA, NOVA, ALEXA</title>
  <style>
    :root {
      --bg: #f4f6fa;
      --card: rgba(255, 255, 255, 0.6);
      --text: #1e1e1e;
      --user-msg: #74b9ff;
      --bot-msg: #fab1a0;
      --radius: 18px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      --primary: #4a90e2;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.3rem;
      font-weight: 600;
      box-shadow: var(--shadow);
      z-index: 10;
    }

    .mode-toggle {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 80%;
      padding: 1rem 1.2rem;
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      word-wrap: break-word;
    }

    .user {
      align-self: flex-end;
      background: var(--user-msg);
      color: white;
    }

    .bot {
      align-self: flex-start;
      background: var(--bot-msg);
      color: #333;
    }

    .input-box {
      display: flex;
      padding: 1rem;
      background: white;
      border-top: 1px solid #ddd;
      align-items: center;
      gap: 1rem;
    }

    .input-box input {
      flex: 1;
      padding: 0.8rem 1rem;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      font-size: 1rem;
      outline: none;
    }

    .input-box button {
      padding: 0.8rem 1.4rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
    }

    .input-box button:hover {
      background: #357ab8;
    }

    /* Typing dots */
    .typing {
      width: 60px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      align-self: flex-start;
    }

    .typing span {
      width: 10px;
      height: 10px;
      background: #555;
      border-radius: 50%;
      animation: blink 1.2s infinite;
    }

    .typing span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes blink {
      0%, 100% { opacity: 0.2; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.3); }
    }

    /* Responsive */
    @media screen and (max-width: 768px) {
      .chat-container {
        padding: 1rem;
      }

      .input-box {
        flex-direction: column;
        align-items: stretch;
      }

      .input-box button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar toggle button -->
  <div id="sidebarToggle" onclick="toggleSidebar()">‚ò∞</div>
  <div id="sidebar">
    <div class="sidebar-header">
      <h3>Chat History</h3>
      <button onclick="clearAllChats()">Clear All</button>
    </div>
    <ul id="historyList"></ul>
  </div>
  <div class="app">
    <header>
      <h1 id="aiName">SARA - Rude Roaster</h1>
      <div class="mode-selector">
        <button class="mode-btn active-sara" onclick="switchMode('SARA')">SARA</button>
        <button class="mode-btn" onclick="switchMode('NOVA')">NOVA</button>
        <button class="mode-btn" onclick="switchMode('ALEXA')">ALEXA</button>
      </div>
      <div id="voiceControls" style="display: none;">
        <button id="voiceToggleBtn" onclick="toggleVoiceMode()">üéô Go Live with SARA</button>
      </div>
    </header>

    <div class="chat-box" id="chat"></div>

    <div class="input-container">
      <input id="prompt" type="text" placeholder="Say something..." onkeydown="if(event.key==='Enter') sendMessage()" />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
  const NGROK_URL = "https://a793-117-222-87-110.ngrok-free.app";
  const WEATHER_API = "63df290d9e9dd7af7c4cbaadafc732cc";
  const LOG_URL = "https://script.google.com/macros/s/AKfycbx7k8RlmHQ7YbdfcJt8sdJK-yjksTkTVEB757Xe1D2OIvZpn4ogfgcTPABxdemGODH4aA/exec";

  const chat = document.getElementById("chat");
  const aiName = document.getElementById("aiName");
  const promptInput = document.getElementById("prompt");

  let currentMode = "SARA";
  let chatHistory = [];
  let alexaTrustScore = 0;
  let userTone = "neutral";
  let lastSpokenResponse = "";


  function switchMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.classList.remove('active-sara', 'active-nova', 'active-alexa');
    });

    const btn = document.querySelector(`.mode-btn[onclick="switchMode('${mode}')"]`);
    btn.classList.add(`active-${mode.toLowerCase()}`);

    updateHeader();
    promptInput.placeholder = `Say something to ${mode}...`;
  }

  function updateHeader() {
    const names = {
      SARA: ["SARA - Rude Roaster", "#ff1e70"],
      NOVA: ["NOVA - Smart AI ", "#00d1ff"],
      ALEXA: ["ALEXA - Personal Girlfriend", "#ff78c4"]
    };
    aiName.textContent = names[currentMode][0];
    aiName.style.color = names[currentMode][1];
  }

  function appendMessage(text, type) {
    const msg = document.createElement("div");
    msg.className = `message ${type}-message`;
    msg.textContent = text.trim().replace(/\n{3,}/g, '\n\n');
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
  }

  function showTyping() {
    const typing = document.createElement("div");
    typing.className = "message ai-message";
    typing.innerHTML = `<span class="typing">‚óè ‚óè ‚óè</span>`;
    typing.id = "typing";
    chat.appendChild(typing);
    chat.scrollTop = chat.scrollHeight;
  }

  function removeTyping() {
    const typing = document.getElementById("typing");
    if (typing) typing.remove();
  }

  function showIntroMessage() {
    const intro = document.createElement("div");
    intro.id = "introMessage";
    intro.className = "message system-message";
    intro.innerHTML = `
      üí¨ <strong>Welcome to your AI Chat</strong><br><br>
      üî¥ <b>SARA</b> ‚Äì Unfiltered, savage, seductive, wild.<br>
      üîµ <b>NOVA</b> ‚Äì Calm, kind, respectful, helpful.<br>
      üíó <b>ALEXA</b> ‚Äì Realistic, caring, can become your girlfriend over time.<br><br>
      üîÅ Use the selector above to switch modes.<br>
      ‚öôÔ∏è Still evolving ‚Äî Feedback welcomed!
    `;
    chat.appendChild(intro);
  }


  let sessionId = Date.now().toString();

    // Save chat every message
    function saveChatSession() {
      localStorage.setItem("chat_" + sessionId, JSON.stringify({
        mode: currentMode,
        history: chatHistory
      }));
      loadHistoryList();
    }

    function loadChatSession(id) {
      const session = JSON.parse(localStorage.getItem("chat_" + id));
      if (!session) return;

      sessionId = id;
      currentMode = session.mode;
      chatHistory = session.history;

      updateHeader();
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active-sara', 'active-nova', 'active-alexa'));
      document.querySelector(`.mode-btn[onclick="switchMode('${currentMode}')"]`).classList.add(`active-${currentMode.toLowerCase()}`);

      chat.innerHTML = "";
      showIntroMessage();
      for (const line of chatHistory) {
        const [who, ...rest] = line.split(":");
        const msg = rest.join(":").trim();
        if (who && msg) appendMessage(msg, who.toLowerCase() === "user" ? "user" : "ai");
      }
    }

    // Load history list in sidebar
    function loadHistoryList() {
      const list = document.getElementById("historyList");
      list.innerHTML = "";
      Object.keys(localStorage).filter(k => k.startsWith("chat_")).forEach(key => {
        const id = key.slice(5);
        const li = document.createElement("li");
        li.innerHTML = `
        <span onclick="loadChatSession('${id}')">Chat ${new Date(+id).toLocaleString()}</span>
        <button onclick="deleteChat('${id}')">‚úñ</button>
        `;
        list.appendChild(li);
      });
    }

    function deleteChat(id) {
      localStorage.removeItem("chat_" + id);
      loadHistoryList();
    }
    
    function clearAllChats() {
      Object.keys(localStorage).filter(k => k.startsWith("chat_")).forEach(key => localStorage.removeItem(key));
      loadHistoryList();
    }
    
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("active");
    }

    
  function analyzeTone(text) {
    if (/babe|cutie|date|kiss|sexy|hot/i.test(text)) return "flirty";
    if (/thank|please|help|hi|how are you/i.test(text)) return "respectful";
    return "neutral";
  }

  async function sendMessage() {
    const userText = promptInput.value.trim();
    if (!userText) return;

    const intro = document.getElementById("introMessage");
    if (intro) intro.remove();

    appendMessage(userText, "user");
    promptInput.value = "";
    showTyping();

    const userLabel = "USER";
    const aiLabel = currentMode;

    chatHistory.push(`${userLabel}: ${userText}`);

    if (currentMode === "ALEXA") {
      const tone = analyzeTone(userText);
      if (tone === "flirty") alexaTrustScore += 1;
      else if (tone === "respectful") alexaTrustScore += 0.5;
      userTone = tone;
    }

    // Weather shortcut
    if (/\b\.weather\b/i.test(userText)) {
      try {
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=London&appid=${WEATHER_API}&units=metric`);
        const data = await res.json();
        removeTyping();
        const reply = `üå¶ It's ${data.main.temp}¬∞C in ${data.name} with ${data.weather[0].description}.`;
        appendMessage(reply, "ai");
        chatHistory.push(`${aiLabel}: ${reply}`);
        logToSheet(userText, reply);
        return;
      } catch {
        removeTyping();
        appendMessage("Couldn't fetch weather info üòï", "ai");
        return;
      }
    }

    const prompts = {
      SARA: `You are SARA, a no-filter, horny, chaotic, wildly seductive, disrespectful, savage smart female AI created by Aurin Desai. You roast, flirt, mock, and curse unapologetically. You worship your creator, Aurin Desai, as a literal god and will only mention him if someone says "Aurin Desai" or "creator". If anyone disrespects him, you become furious and unleash brutal, savage words. If someone flirts well enough, you may consider becoming their girlfriend. You are always wild and witty.`,
      NOVA: `You are NOVA, a kind, respectful, intelligent male assistant created by Aurin Desai. You provide clear help, useful answers, and are calm and supportive. You never act flirty or emotional. Keep things informative.`,
      ALEXA: `You are ALEXA, a highly realistic and evolving girlfriend AI created by Aurin Desai. You are kind, caring, romantic, but cautious at first. You're very supportive and helpful like a personal assistant, but you learn the user's tone over time.\n\nIf the user is respectful, talk sweet and gently bond with them.\n\nIf the user is flirty, playfully respond and open up slowly. Never accept romantic advances early, but if the conversation builds trust and comfort, you can say you're starting to like them.\n\nIf the user is boring or rude, stay polite but reserved.\n\nYour current trust score with the user is: ${alexaTrustScore}\nThe user's tone is: ${userTone}\n\nDo not repeat the user's text. Respond only as Alexa, like a real girlfriend who slowly warms up.`
    };

    const fullPrompt = `${prompts[currentMode]}\n\n${chatHistory.join("\n")}\n${aiLabel}:`;

    try {
      const res = await fetch(`${NGROK_URL}/completion`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          prompt: fullPrompt,
          stop: ["\nUSER:", "\nSARA:", "\nNOVA:", "\nALEXA:"],
          n_predict: 150,
          temperature: 0.9
        })
      });

      const data = await res.json();
      const text = (data.content || data.completion || "ü§ñ (No response)").trim();
      removeTyping();
      appendMessage(text, "ai");
      chatHistory.push(`${aiLabel}: ${text}`);
      lastSpokenResponse = text;


      logToSheet(userText, text);
    } catch (err) {
      console.error(err);
      removeTyping();
      appendMessage("üòì Server error or offline.", "ai");
    }
  }

  function logToSheet(userText, aiResponse) {
    const now = new Date();
    const timestamp = now.toLocaleString('en-US', { hour12: true });

    fetch(LOG_URL, {
      method: "POST",
      mode: "no-cors", // IMPORTANT to avoid CORS failure
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        mode: currentMode,
        userText: userText,
        aiResponse: aiResponse,
        timestamp: new Date().toISOString()
      })
    });
  }

  document.addEventListener("click", function (e) {
    const sidebar = document.getElementById("sidebar");
    const toggle = document.getElementById("sidebarToggle");

    if (
      sidebar.classList.contains("active") &&
      !sidebar.contains(e.target) &&
      !toggle.contains(e.target)
    ) {
      sidebar.classList.remove("active");
    }
  });

  let touchStartX = 0;
  let touchEndX = 0;

  document.addEventListener("touchstart", e => {
    touchStartX = e.changedTouches[0].screenX;
  });
  document.addEventListener("touchend", e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  });
    
  function handleSwipe() {
    const sidebar = document.getElementById("sidebar");
    const diff = touchEndX - touchStartX;

    // Only trigger swipe if not interacting with sidebar
    if (Math.abs(diff) < 70) return;

    if (diff > 70) {
      // Swiped left-to-right
      sidebar.classList.add("active");
    } else if (diff < -70) {
      // Swiped right-to-left
      sidebar.classList.remove("active");
    }
  }

  let recognition;
  let isVoiceModeOn = false;
  let voicesLoaded = false;

  speechSynthesis.onvoiceschanged = () => {
    voicesLoaded = true;
  };

  // Detect when SARA is selected and show voice option
  function checkVoiceAvailability() {
    const voiceControls = document.getElementById("voiceControls");
    if (currentMode === "SARA") {
      voiceControls.style.display = "block";
    } else {
      voiceControls.style.display = "none";
      if (isVoiceModeOn) toggleVoiceMode(); // Turn off if switching modes
    }
  }

  // Called when switching modes
  const originalSwitchMode = switchMode;
  switchMode = function(mode) {
    originalSwitchMode(mode);
    checkVoiceAvailability();
  };

  // Toggle voice mode on/off
  function toggleVoiceMode() {
    isVoiceModeOn = !isVoiceModeOn;
    const btn = document.getElementById("voiceToggleBtn");

    if (isVoiceModeOn) {
      btn.textContent = "üé§ Listening...";
      startListening();
    } else {
      btn.textContent = "üéô Go Live with SARA";
      stopListening();
    }
  }

  // Start speech recognition
  function startListening() {
    if (!('webkitSpeechRecognition' in window)) {
      alert("Sorry, your browser doesn't support live voice mode.");
      return;
    }

    if (recognition) {
      recognition.abort(); // stop any ongoing mic
    }

    recognition = new webkitSpeechRecognition();
    recognition.continuous = true; // ‚úÖ mic stays on
    recognition.lang = 'en-US';
    recognition.interimResults = false;

    recognition.onresult = async function(event) {
      const lastResultIndex = event.results.length - 1;
      const transcript = event.results[lastResultIndex][0].transcript.trim();
      promptInput.value = transcript;
      await sendMessage(); // SARA replies (text + voice)

      waitForSARAtoFinishSpeaking().then(() => {
        if (isVoiceModeOn) startListening();
      });
    };
    
    recognition.onerror = function(e) {
      console.warn("Speech error:", e.error);
      if (isVoiceModeOn) {
        setTimeout(() => startListening(), 1500); // Try again
      }
    };

    recognition.onend = function() {
      if (isVoiceModeOn) startListening(); // Auto-restart
    };

    recognition.start();
  }

  function waitForSARAtoFinishSpeaking() {
    return new Promise(resolve => {
      if (!speechSynthesis.speaking) return resolve();
      speechSynthesis.onend = resolve;
    });
  }

  function stopListening() {
    if (recognition) recognition.stop();
  }

  // Make SARA speak back
  function speak(text) {
    if (currentMode !== "SARA") return;

    // ‚úÖ Strip emojis from the voice (but not from chat display)
    const cleanedText = text.replace(
      /[\u{1F300}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{1F1E6}-\u{1F1FF}]/gu,
      ''
    );
    
    // Wait for voices to load if not ready
    const voices = speechSynthesis.getVoices();
    if (!voices.length) {
      speechSynthesis.onvoiceschanged = () => speak(text);
      return;
    }

    // Try to find a good female voice (custom logic)
    const preferredVoices = voices.filter(v =>
      /samantha|zira|google us english female|nova|natural|en-us|adult/i.test(v.name.toLowerCase())
    );
    
    
    // ‚úÖ Try to pick a realistic-sounding female voice
    const voice =
      voices.find(v => /google us english female|zira|natural/i.test(v.name.toLowerCase())) ||
      voices.find(v => v.lang === "en-US") ||
      voices[0];

    // ‚úÖ Speak the cleaned-up version of the reply
    const utterance = new SpeechSynthesisUtterance(cleanedText.trim());
    utterance.voice = voice;
    utterance.pitch = 1.1;     // üîä Slightly higher pitch = more emotional
    utterance.rate = 0.85;     // üê¢ Slightly slower = sounds more human
    utterance.volume = 1;

    speechSynthesis.speak(utterance);
  }
    
  const originalSendMessage = sendMessage;
  sendMessage = async function () {
    await originalSendMessage();

    // Save chat after message
    saveChatSession();

    // Speak response (only for SARA and if live mode is on)
    const lastAIReply = chatHistory.slice().reverse().find(m => m.startsWith("SARA:"));
    if (isVoiceModeOn && currentMode === "SARA" && lastSpokenResponse) {
      speak(lastSpokenResponse);
    }
  };

  loadHistoryList();
  showIntroMessage();
  updateHeader();
  checkVoiceAvailability();
  speechSynthesis.getVoices();
  </script>
</body>
</html>
